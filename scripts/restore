#!/bin/bash
#=================================================
# YunoHost restore script for Atuin server
#=================================================
set -euo pipefail

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# LOAD SETTINGS / RESOURCES
#=================================================
: "${install_dir:?install_dir is required}"
: "${data_dir:?data_dir is required}"
: "${port:?port is required}"

app_user="$app"
app_group="$app"

# Ensure path starts with '/' if present (may be needed by nginx template substitutions)
if [[ -n "${path:-}" && "${path}" != /* ]]; then
  path="/${path}"
fi

#=================================================
# HELPER: safe template rendering (sed with escaping)
#=================================================
_escape_sed_repl() {
  printf '%s' "$1" | sed -e 's/[\\&|]/\\&/g'
}

render_template() {
  local src="$1"
  local dest="$2"

  if [[ ! -f "$src" ]]; then
    ynh_die --message="Missing template: $src"
  fi

  cp -f "$src" "$dest"

  local app_esc install_esc data_esc port_esc path_esc
  app_esc="$(_escape_sed_repl "$app")"
  install_esc="$(_escape_sed_repl "$install_dir")"
  data_esc="$(_escape_sed_repl "$data_dir")"
  port_esc="$(_escape_sed_repl "$port")"
  path_esc="$(_escape_sed_repl "${path:-/}")"

  sed -i \
    -e "s|__APP__|$app_esc|g" \
    -e "s|__INSTALL_DIR__|$install_esc|g" \
    -e "s|__DATA_DIR__|$data_esc|g" \
    -e "s|__PORT__|$port_esc|g" \
    -e "s|__PATH__|$path_esc|g" \
    "$dest"
}

#=================================================
# RESTORE
#=================================================
ynh_script_progression --message="Restoring $app..." --weight=10

# Stop service if it exists (best effort)
systemctl stop "$app" || true

# Restore install_dir + data_dir (provided by YunoHost backup context)
ynh_restore_file --origin_path="$install_dir"
ynh_restore_file --origin_path="$data_dir"

# Fix ownership/permissions for data dir
install -d -m 0750 -o "$app_user" -g "$app_group" "$data_dir"
chown -R "$app_user:$app_group" "$data_dir" || true
chmod 0750 "$data_dir" || true

# Ensure expected files permissions (do not overwrite content)
if [[ -f "$data_dir/server.toml" ]]; then
  chown "$app_user:$app_group" "$data_dir/server.toml" || true
  chmod 0640 "$data_dir/server.toml" || true
fi
if [[ -f "$data_dir/atuin.env" ]]; then
  chown "$app_user:$app_group" "$data_dir/atuin.env" || true
  chmod 0640 "$data_dir/atuin.env" || true
fi
if [[ -f "$data_dir/atuin.sqlite" ]]; then
  chown "$app_user:$app_group" "$data_dir/atuin.sqlite" || true
  chmod 0640 "$data_dir/atuin.sqlite" || true
fi

# Restore systemd unit if it was part of the backup; otherwise render from template
systemd_unit="/etc/systemd/system/${app}.service"
if [[ -f "$systemd_unit" ]]; then
  ynh_restore_file --origin_path="$systemd_unit" || true
else
  render_template "../conf/atuin.service" "$systemd_unit"
  chmod 0644 "$systemd_unit"
fi

systemctl daemon-reload || true
systemctl enable "$app" || true

# Restore nginx conf if it was part of the backup; otherwise render from template
if [[ -n "${domain:-}" ]]; then
  nginx_dir="/etc/nginx/conf.d/${domain}.d"
  nginx_conf="${nginx_dir}/${app}.conf"

  mkdir -p "$nginx_dir"
  if [[ -f "$nginx_conf" ]]; then
    ynh_restore_file --origin_path="$nginx_conf" || true
  else
    render_template "../conf/nginx.conf" "$nginx_conf"
    chmod 0644 "$nginx_conf"
  fi

  nginx -t >/dev/null 2>&1 && systemctl reload nginx || true
fi

# Start service
systemctl restart "$app" || true

ynh_script_progression --message="Restore of $app completed." --last

