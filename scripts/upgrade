#!/bin/bash
#=================================================
# YunoHost upgrade script for Atuin server
#=================================================
set -euo pipefail

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# LOAD SETTINGS / RESOURCES
#=================================================
: "${domain:?domain is required}"
: "${path:=/}"
: "${install_dir:?install_dir is required}"
: "${data_dir:?data_dir is required}"
: "${port:?port is required}"

app_user="$app"
app_group="$app"

# Ensure path starts with '/'
if [[ "${path}" != /* ]]; then
  path="/${path}"
fi

#=================================================
# HELPER: safe template rendering (sed with escaping)
#=================================================
_escape_sed_repl() {
  printf '%s' "$1" | sed -e 's/[\\&|]/\\&/g'
}

render_template() {
  local src="$1"
  local dest="$2"

  if [[ ! -f "$src" ]]; then
    ynh_die --message="Missing template: $src"
  fi

  cp -f "$src" "$dest"

  local app_esc install_esc data_esc port_esc path_esc
  app_esc="$(_escape_sed_repl "$app")"
  install_esc="$(_escape_sed_repl "$install_dir")"
  data_esc="$(_escape_sed_repl "$data_dir")"
  port_esc="$(_escape_sed_repl "$port")"
  path_esc="$(_escape_sed_repl "$path")"

  sed -i \
    -e "s|__APP__|$app_esc|g" \
    -e "s|__INSTALL_DIR__|$install_esc|g" \
    -e "s|__DATA_DIR__|$data_esc|g" \
    -e "s|__PORT__|$port_esc|g" \
    -e "s|__PATH__|$path_esc|g" \
    "$dest"
}

#=================================================
# STOP SERVICE (best effort)
#=================================================
ynh_script_progression --message="Stopping $app service…" --weight=10
systemctl stop "$app" || true

#=================================================
# UPGRADE ATUIN BINARY
#=================================================
ynh_script_progression --message="Upgrading Atuin binary…" --weight=30

tmp_src="$(mktemp -d)"
ynh_setup_source --dest_dir="$tmp_src"

if [[ ! -f "$tmp_src/atuin" ]]; then
  ynh_die --message="Atuin binary not found in extracted source (expected: $tmp_src/atuin)."
fi

install -d -m 0755 "$install_dir"
install -Dm755 "$tmp_src/atuin" "$install_dir/atuin"
rm -rf "$tmp_src"

#=================================================
# ENSURE DATA DIR + FILE PERMISSIONS (do not overwrite existing config)
#=================================================
ynh_script_progression --message="Ensuring configuration and permissions…" --weight=25

install -d -m 0750 -o "$app_user" -g "$app_group" "$data_dir"

server_config="$data_dir/server.toml"
env_path="$data_dir/atuin.env"
db_path="$data_dir/atuin.sqlite"

# Create server.toml only if missing (do not overwrite user edits)
if [[ ! -f "$server_config" ]]; then
  render_template "../conf/server.toml" "$server_config"
fi

# Create atuin.env only if missing (do not overwrite user edits)
if [[ ! -f "$env_path" ]]; then
  cat > "$env_path" <<EOF
# Autogenerated by YunoHost during upgrade
RUST_LOG=info,atuin=debug,atuin_server=debug,tower_http=info
RUST_BACKTRACE=1
EOF
fi

chown "$app_user:$app_group" "$server_config" "$env_path"
chmod 0640 "$server_config" "$env_path"

# Ensure sqlite file exists with correct permissions (if using sqlite)
if [[ ! -f "$db_path" ]]; then
  install -m 0640 -o "$app_user" -g "$app_group" /dev/null "$db_path"
else
  chown "$app_user:$app_group" "$db_path" || true
  chmod 0640 "$db_path" || true
fi

#=================================================
# UPDATE SYSTEMD UNIT
#=================================================
ynh_script_progression --message="Updating systemd service…" --weight=20

systemd_unit="/etc/systemd/system/${app}.service"
render_template "../conf/atuin.service" "$systemd_unit"
chmod 0644 "$systemd_unit"

systemctl daemon-reload

#=================================================
# UPDATE NGINX CONFIG
#=================================================
ynh_script_progression --message="Updating NGINX reverse proxy…" --weight=15

nginx_dir="/etc/nginx/conf.d/${domain}.d"
nginx_conf="${nginx_dir}/${app}.conf"
mkdir -p "$nginx_dir"

render_template "../conf/nginx.conf" "$nginx_conf"
chmod 0644 "$nginx_conf"

nginx -t
systemctl reload nginx

#=================================================
# START SERVICE
#=================================================
ynh_script_progression --message="Starting $app service…" --weight=10

systemctl enable "$app" || true
systemctl restart "$app"

#=================================================
# END
#=================================================
ynh_script_progression --message="Upgrade of $app completed." --last

