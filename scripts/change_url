#!/bin/bash
#=================================================
# YunoHost change_url script for Atuin server
#=================================================

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# Local helpers (inline: avoid sourcing extra files after YunoHost helpers)
#=================================================

_escape_sed_repl() {
  # Escape \, &, and delimiter | for sed replacement
  printf '%s' "$1" | sed -e 's/[\\&|]/\\&/g'
}

render_template() {
  local src="$1"
  local dest="$2"

  if [[ ! -f "$src" ]]; then
    ynh_die --message="Missing template: $src"
  fi

  cp -f "$src" "$dest"

  local app_esc install_esc data_esc port_esc path_esc
  app_esc="$(_escape_sed_repl "$app")"
  install_esc="$(_escape_sed_repl "$install_dir")"
  data_esc="$(_escape_sed_repl "$data_dir")"
  port_esc="$(_escape_sed_repl "$port")"
  path_esc="$(_escape_sed_repl "$path")"

  sed -i \
    -e "s|__APP__|$app_esc|g" \
    -e "s|__INSTALL_DIR__|$install_esc|g" \
    -e "s|__DATA_DIR__|$data_esc|g" \
    -e "s|__PORT__|$port_esc|g" \
    -e "s|__PATH__|$path_esc|g" \
    "$dest"
}

ynh_systemd_do() {
  local service_name="$1"
  local action="$2"

  if command -v ynh_systemd_action >/dev/null 2>&1; then
    ynh_systemd_action --service_name="$service_name" --action="$action" --log_path=systemd
  else
    systemctl "$action" "$service_name"
  fi
}

#=================================================
# LOAD SETTINGS / RESOURCES
#=================================================
: "${domain:?domain is required}"
: "${path:=/}"
: "${install_dir:?install_dir is required}"
: "${data_dir:?data_dir is required}"
: "${port:?port is required}"

# These are typically provided by YunoHost during change_url
: "${new_domain:?new_domain is required}"
: "${new_path:=/}"

# Ensure paths start with '/'
if [[ "${path}" != /* ]]; then
  path="/${path}"
fi
if [[ "${new_path}" != /* ]]; then
  new_path="/${new_path}"
fi

# change_url runs from .../scripts, resolve app root for conf/*
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
app_root="$(cd "$script_dir/.." && pwd)"

#=================================================
# CHANGE URL
#=================================================
ynh_script_progression --message="Updating URL for $app..." --weight=20

# Update variables used by templates
domain="$new_domain"
path="$new_path"

#-------------------------------------------------
# NGINX REVERSE PROXY
#-------------------------------------------------
ynh_script_progression --message="Updating NGINX reverse proxy…" --weight=50

# Remove old nginx conf (best effort)
old_nginx_conf="/etc/nginx/conf.d/${new_domain}.d/${app}.conf"
# We cannot reliably know the old domain dir if domain already changed in env,
# so remove any existing conf for this app.
shopt -s nullglob
for f in /etc/nginx/conf.d/*.d/${app}.conf; do
  rm -f "$f" || true
done
shopt -u nullglob

# Install new nginx conf
nginx_dir="/etc/nginx/conf.d/${domain}.d"
nginx_conf="${nginx_dir}/${app}.conf"
mkdir -p "$nginx_dir"

render_template "$app_root/conf/nginx.conf" "$nginx_conf"
chmod 0644 "$nginx_conf"

if ! nginx -t; then
  ynh_die --message="nginx -t failed, refusing to reload nginx."
fi
systemctl reload nginx

#-------------------------------------------------
# RESTART SERVICE (best effort)
#-------------------------------------------------
ynh_script_progression --message="Restarting $app…" --weight=30
ynh_systemd_do "$app" restart || true

#=================================================
# END
#=================================================
ynh_script_progression --message="URL update for $app completed." --last

