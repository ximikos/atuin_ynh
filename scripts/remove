#!/bin/bash
#=================================================
# YunoHost remove script for Atuin server
#=================================================

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# Local helpers (inline: avoid sourcing extra files after YunoHost helpers)
#=================================================

ynh_rm_tree() {
  local target="$1"
  if command -v ynh_secure_remove >/dev/null 2>&1; then
    ynh_secure_remove --file="$target"
  elif command -v ynh_safe_rm >/dev/null 2>&1; then
    ynh_safe_rm "$target"
  else
    ynh_die --message="No safe remove helper available to delete: $target"
  fi
}

ynh_systemd_do() {
  local service_name="$1"
  local action="$2"

  if command -v ynh_systemd_action >/dev/null 2>&1; then
    ynh_systemd_action --service_name="$service_name" --action="$action" --log_path=systemd
  else
    systemctl "$action" "$service_name"
  fi
}

#=================================================
# REMOVE
#=================================================
ynh_script_progression --message="Removing system configurations related to $app..." --weight=10

#-------------------------------------------------
# SYSTEMD
#-------------------------------------------------
systemd_unit="/etc/systemd/system/${app}.service"

ynh_systemd_do "$app" stop || true
systemctl disable --quiet "$app" || true

if [[ -f "$systemd_unit" ]]; then
  rm -f "$systemd_unit" || true
  systemctl daemon-reload || true
fi

# Ensure nothing is still running under the app user (best effort)
if id -u "$app" >/dev/null 2>&1; then
  pkill -u "$app" || true
  sleep 1
  pkill -KILL -u "$app" || true
fi

#-------------------------------------------------
# NGINX
#-------------------------------------------------
# Remove /etc/nginx/conf.d/<domain>.d/<app>.conf without relying on $domain
shopt -s nullglob
nginx_confs=(/etc/nginx/conf.d/*.d/${app}.conf)
shopt -u nullglob

if (( ${#nginx_confs[@]} > 0 )); then
  for f in "${nginx_confs[@]}"; do
    rm -f "$f" || true
    d="$(dirname "$f")"
    if [[ -d "$d" ]] && [[ -z "$(ls -A "$d" 2>/dev/null)" ]]; then
      rmdir "$d" || true
    fi
  done

  if command -v nginx >/dev/null 2>&1; then
    nginx -t >/dev/null 2>&1 && systemctl reload nginx || true
  else
    systemctl reload nginx || true
  fi
fi

#-------------------------------------------------
# OTHER FILES (best effort; only if they exist)
#-------------------------------------------------
if [[ -f "/etc/cron.d/$app" ]]; then
  rm -f "/etc/cron.d/$app" || true
fi

if [[ -d "/etc/$app" ]]; then
  ynh_rm_tree "/etc/$app"
fi

#=================================================
# END
#=================================================
ynh_script_progression --message="Removal of $app completed" --last

