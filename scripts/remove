#!/bin/bash
#=================================================
# YunoHost remove script for Atuin server
#=================================================
set -euo pipefail

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# REMOVE SYSTEM CONFIGURATION
#=================================================
ynh_script_progression --message="Removing system configurations related to $app..." --weight=10

#-------------------------------------------------
# SYSTEMD
#-------------------------------------------------
systemd_unit="/etc/systemd/system/${app}.service"

# Stop/disable the service if systemd knows it (or if the unit file exists)
if systemctl list-unit-files 2>/dev/null | grep -q "^${app}\.service" || [[ -f "$systemd_unit" ]]; then
  systemctl stop "$app" || true
  systemctl disable "$app" || true
fi

# Remove the unit file if present
if [[ -f "$systemd_unit" ]]; then
  rm -f "$systemd_unit"
  systemctl daemon-reload || true
fi

# Ensure no processes are still running under the app user
# (otherwise core can't delete the system_user resource)
if id -u "$app" >/dev/null 2>&1; then
  pkill -u "$app" || true
  sleep 1
  pkill -KILL -u "$app" || true
fi

#-------------------------------------------------
# NGINX
#-------------------------------------------------
# Matches install path: /etc/nginx/conf.d/${domain}.d/${app}.conf
if [[ -n "${domain:-}" ]]; then
  nginx_dir="/etc/nginx/conf.d/${domain}.d"
  nginx_conf="${nginx_dir}/${app}.conf"

  if [[ -f "$nginx_conf" ]]; then
    rm -f "$nginx_conf"
  fi

  # Remove empty per-domain dir if empty
  if [[ -d "$nginx_dir" ]] && [[ -z "$(ls -A "$nginx_dir" 2>/dev/null)" ]]; then
    rmdir "$nginx_dir" || true
  fi

  # Validate + reload nginx (best effort)
  if command -v nginx >/dev/null 2>&1; then
    nginx -t >/dev/null 2>&1 && systemctl reload nginx || true
  else
    systemctl reload nginx || true
  fi
fi

#-------------------------------------------------
# OTHER FILES (only if you actually created them)
#-------------------------------------------------
ynh_safe_rm "/etc/cron.d/$app"
ynh_safe_rm "/etc/$app"

#=================================================
# END
#=================================================
ynh_script_progression --message="Removal of $app completed" --last

