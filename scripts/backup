#!/bin/bash
#=================================================
# YunoHost backup script for Atuin server
#=================================================
set -euo pipefail

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# BACKUP
#=================================================
ynh_script_progression --message="Backing up $app..." --weight=10

# These variables are expected to be provided by the app script context:
# $install_dir, $data_dir, $domain, $path, $port, ...
: "${install_dir:?install_dir is required}"
: "${data_dir:?data_dir is required}"

# Stop service to keep SQLite consistent (best effort)
systemctl stop "$app" || true

# Backup install dir (binary)
ynh_backup --src_path="$install_dir"

# Backup data dir (server.toml, atuin.env, sqlite DB)
ynh_backup --src_path="$data_dir"

# Also backup the system configs we created manually (best effort)
ynh_backup --src_path="/etc/systemd/system/${app}.service" || true
if [[ -n "${domain:-}" ]]; then
  ynh_backup --src_path="/etc/nginx/conf.d/${domain}.d/${app}.conf" || true
fi

# Start service again
systemctl start "$app" || true

ynh_script_progression --message="Backup of $app completed." --last

