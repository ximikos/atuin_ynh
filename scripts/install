#!/bin/bash
#=================================================
# YunoHost install script for Atuin server
#=================================================

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# Local helpers (inline: avoid sourcing extra files after YunoHost helpers)
#=================================================

_escape_sed_repl() {
  # Escape \, &, and delimiter | for sed replacement
  printf '%s' "$1" | sed -e 's/[\\&|]/\\&/g'
}

render_template() {
  local src="$1"
  local dest="$2"

  if [[ ! -f "$src" ]]; then
    ynh_die --message="Missing template: $src"
  fi

  cp -f "$src" "$dest"

  local app_esc install_esc data_esc port_esc path_esc
  app_esc="$(_escape_sed_repl "$app")"
  install_esc="$(_escape_sed_repl "$install_dir")"
  data_esc="$(_escape_sed_repl "$data_dir")"
  port_esc="$(_escape_sed_repl "$port")"
  path_esc="$(_escape_sed_repl "$path")"

  sed -i \
    -e "s|__APP__|$app_esc|g" \
    -e "s|__INSTALL_DIR__|$install_esc|g" \
    -e "s|__DATA_DIR__|$data_esc|g" \
    -e "s|__PORT__|$port_esc|g" \
    -e "s|__PATH__|$path_esc|g" \
    "$dest"
}

ynh_rm_tree() {
  local target="$1"
  if command -v ynh_secure_remove >/dev/null 2>&1; then
    ynh_secure_remove --file="$target"
  elif command -v ynh_safe_rm >/dev/null 2>&1; then
    ynh_safe_rm "$target"
  else
    ynh_die --message="No safe remove helper available to delete: $target"
  fi
}

ynh_systemd_do() {
  local service_name="$1"
  local action="$2"

  if command -v ynh_systemd_action >/dev/null 2>&1; then
    ynh_systemd_action --service_name="$service_name" --action="$action" --log_path=systemd
  else
    systemctl "$action" "$service_name"
  fi
}

#=================================================
# LOAD SETTINGS / RESOURCES
#=================================================
: "${domain:?domain is required}"
: "${path:=/}"
: "${install_dir:?install_dir is required}"
: "${data_dir:?data_dir is required}"
: "${port:?port is required}"

app_user="$app"
app_group="$app"

# Ensure path starts with '/'
if [[ "${path}" != /* ]]; then
  path="/${path}"
fi

# install runs from .../scripts, resolve app root for conf/*
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
app_root="$(cd "$script_dir/.." && pwd)"

#=================================================
# DEPLOY ATUIN BINARY
#=================================================
ynh_script_progression --message="Deploying Atuin…" --weight=20

tmp_src="$(mktemp -d)"
ynh_setup_source --dest_dir="$tmp_src"

if [[ ! -f "$tmp_src/atuin" ]]; then
  ynh_rm_tree "$tmp_src"
  ynh_die --message="Atuin binary not found in extracted source (expected: $tmp_src/atuin)."
fi

install -d -m 0755 "$install_dir"
install -Dm755 "$tmp_src/atuin" "$install_dir/atuin"
ynh_rm_tree "$tmp_src"

#=================================================
# CONFIGURE DATA DIR + CONFIG FILES
#=================================================
ynh_script_progression --message="Configuring Atuin…" --weight=30

install -d -m 0750 -o "$app_user" -g "$app_group" "$data_dir"

db_path="$data_dir/atuin.sqlite"
config_path="$data_dir/server.toml"
env_path="$data_dir/atuin.env"

# Render server.toml
render_template "$app_root/conf/server.toml" "$config_path"

# Environment (keep sane defaults)
cat > "$env_path" <<EOF
# Autogenerated by YunoHost during install
RUST_LOG=info
RUST_BACKTRACE=1
EOF

chown "$app_user:$app_group" "$config_path" "$env_path"
chmod 0640 "$config_path" "$env_path"

# Pre-create SQLite DB file for correct permissions (only if missing)
if [[ ! -f "$db_path" ]]; then
  install -m 0640 -o "$app_user" -g "$app_group" /dev/null "$db_path"
else
  chown "$app_user:$app_group" "$db_path" || true
  chmod 0640 "$db_path" || true
fi

#=================================================
# SYSTEMD SERVICE
#=================================================
ynh_script_progression --message="Installing systemd service…" --weight=25

systemd_unit="/etc/systemd/system/${app}.service"
render_template "$app_root/conf/atuin.service" "$systemd_unit"
chmod 0644 "$systemd_unit"

systemctl daemon-reload
systemctl enable --quiet "$app"
ynh_systemd_do "$app" restart

#=================================================
# NGINX REVERSE PROXY
#=================================================
ynh_script_progression --message="Configuring NGINX reverse proxy…" --weight=20

nginx_dir="/etc/nginx/conf.d/${domain}.d"
nginx_conf="${nginx_dir}/${app}.conf"
mkdir -p "$nginx_dir"

render_template "$app_root/conf/nginx.conf" "$nginx_conf"
chmod 0644 "$nginx_conf"

if ! nginx -t; then
  ynh_die --message="nginx -t failed, refusing to reload nginx."
fi
systemctl reload nginx

#=================================================
# END
#=================================================
ynh_script_progression --message="Installation of $app completed." --last

